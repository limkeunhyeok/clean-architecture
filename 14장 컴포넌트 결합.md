# Clean Architecture

## 04 컴포넌트 원치

### 14장 컴포넌트 결합

#### ADP: 의존성 비순환 원칙

> 컴포넌트 의존성 그래프에 순환이 있어서는 안 된다.

- 대규모 프로젝트에서 서로 의존하는 부분을 다른 사람이 건들여서 숙취 증후군이 발생한다.
  - 소수의 개발자로 구성된 상대적으로 작은 프로젝트에서는 이 증후군이 그다지 큰 문제가 되지 않으나, 규모가 커지면 심각한 문제가 발생할 수 있다.
- 이 문제에 대한 해결책으로 다음 두 가지 방법이 있다.
  - 주 단위 빌드(weekly build)
  - 의존성 비순환 원칙(Acyclic Dependencies Principle, ADP)

##### 주 단위 빌드

- 중간 규모의 프로젝트에서 흔히 사용된다.
- 주 단위 빌드는 일주일의 첫 4일을 각자 코딩하고 금요일에 통합 및 빌드를 몰아서 한다.
- 주 단위 빌드의 장점으로 빠른 피드백이 가능하고, 고립되어 편안하게 개발이 가능하다.
- 주 단위 빌드의 단점으로 프로젝트가 커지면 통합하는데 오래 걸리고, 통합에 드는 시간이 늘어나면 팀의 효율성이 나빠진다.

##### 순환 의존성 제거하기

- 주 단위 빌드의 단점에 대한 해결책으로 개발 환경을 릴리스 가능한 컴포넌트 단위로 분리한다.
  - 특정 컴포넌트가 변경되더라도 다른 팀에 즉각적으로 영향을 주지 않고 해당 릴리즈를 반영할 시간을 준다.
- 이 절차를 위해서 의존성 구조에 순환이 없도록 관리한다.

![전형적인 컴포넌트 다이어그램](https://i.stack.imgur.com/wMBnI.png)

- 위 구조는 방향 그래프(directed graph)이다.
- 컴포넌트는 정점(vertext)에 해당하고, 의존성 관계는 방향이 있는 간선(directed edge)에 해당한다.
- 어느 컴포넌트에서 시작하든, 의존성 관계를 따라가면서 최초의 컴포넌트로 돌아갈 수 없다.
- 이 구조는 비순환 방향 그래프(Directed Acyclic Graph, DAG)다.
- 컴포넌트 구성요소 간 의존성을 파악하고 있으면 시스템을 빌드하는 방법과 순서를 알 수 있다.

##### 순환이 컴포넌트 의존성 그래프에 미치는 영향

- 순환이 생기면 사실상 하나의 거대한 컴포넌트가 되어 버린다.
- 의존성 그래프에 순환이 생기면 컴포넌트를 분리하기가 어려워진다.
  - 단위 테스트에 어려움을 겪고, 에러가 쉽게 발생한다.
  - 모듈이 증가하면서 빌드 이슈가 발생한다.

##### 순환 끊기

- 의존성 역전을 이용한다.

![의존성 역전 이용](https://velog.velcdn.com/images/ssuh0o0/post/da3a12d3-e6da-4ee9-89fe-2c012eb0a036/image.png)

- 순환 하는 부분 모두가 의존하는 새로운 컴포넌트를 만들고, 의존하는 클래스들을 새로운 컴포넌트로 이동시킨다.

![새로운 컴포넌트](https://velog.velcdn.com/images/hellojihyoung/post/403f5960-0a8a-41f7-9dc7-130f623c2768/image.png)

##### 흐트러짐

- 요구사항이 변경되면 컴포넌트 구조도 변경될 수 있다.
  - 새로운 컴포넌트를 생성하거나 의존성 구조가 더 커질 수도 있음을 의미한다.

#### 하향식(top-down) 설계

- 컴포넌트는 시스템에서 가장 먼저 설계할 수 있는 대상이 아니기 때문에, 하향식으로 설계될 수 없다.
- 컴포넌트 의존성 다이어그램은 애플리케이션의 기능을 의미하지는 않는다.
  - 오히려 애플리케이션의 빌드 가능성(buuildability)과 유지보수성(maintainability)을 보여주는 지도(map)와 같다.
- 아무런 클래스도 설계하지 않은 상태에서 컴포넌트 의존성 구조를 설계하려고 하면 실패를 할 것이다.
- 컴포넌트 의존성 구조는 시스템의 논리적 설계에 발맞춰 성장하며 진화해야 한다.

#### SDP: 안정된 의존성 원칙

> 안정성의 방향으로(더 안정된 쪽에) 의존하라

- 설계는 결코 정적일 수 없다.
  - 설계를 유지하다보면 변경은 불가피하다.
- 변경이 쉽지 않은 컴포넌트가 변동이 예상되는 컴포넌트에 의존하게 만들어서는 안 된다.

##### 안정성

- 소프트웨어 컴포넌트를 변경하기 어렵게 만드는 확실한 방법은 수많은 컴포넌트가 해당 컴포넌트에 의존하게 만드는 것이다.

![x는 안정된 컴포넌트](https://velog.velcdn.com/images/ssuh0o0/post/45c4a2b8-5072-40e7-a057-6dd3d3b1104c/image.png)

- 세 컴포넌트가 x에 의존하며, x 컴포넌트를 변경하지 말아야 할 이유가 세 가지나 되기 때문에 안정적이다.
- x는 세 컴포넌트를 책임지고 있다. 그러나, x가 변경되도록 마들 수 있는 외적인 영향은 없기 때문에 독립적이다.

![y는 불안정된 컴포넌트](https://velog.velcdn.com/images/ssuh0o0/post/f133f518-65ed-462a-a7a8-52c1b56505dd/image.png)

- y는 세 컴포넌트에 의존하며, y에 의존하는 컴포넌트는 없기 떄문에, 책임성이 없으며, 의존적이라고 볼 수 있다.

##### 안정성 지표

- 불안정성: I = Fan-out / (Fan-in + Fan-out) , I =1이면, 최고로 불안정한 컴포넌트, I = 0이면, 최고로 안정한 컴포넌트다.
- Fan-in: 안으로 들어오는 의존성. 이 지표는 컴포넌트 내부의 클래스에 의존하는 컴포넌트 외부의 클래스 개수를 나타낸다.
- Fan-out: 바깥으로 나가는 의존성. 이 지표는 컴포넌트 외부의 클래스에 의존하는 컴포넌트 내부의 클래스 개수를 나타낸다.
- 의존성 방향으로 갈수록 I지표 값이 감소해야 한다.

참고: https://techblog.woowahan.com/2561/

##### 모든 컴포넌트가 안정적이어야 하는 것은 아니다

- 모든 컴포넌트가 안정적이라면 변경은 불가능하다.

![이상적인 구성](https://velog.velcdn.com/images/ssuh0o0/post/85748131-963f-485f-b68e-9795858fd4f1/image.png)

- 위쪽엔 변경 가능한 컴포넌트, 아래쪽엔 안정된 컴포넌트에 의존한다.
  - 다어어그램에서 불안정한 컴포넌트를 관례적으로 위쪽에 둔다.

##### 추상 컴포넌트

- 오로지 인터페이스만을 포함하는 컴포넌트를 생성하는 방식인 추상 컴포넌트는 상당히 안정적이며, 따라서 덜 안정적인 컴포넌트가 의존할 수 있는 이상적인 대상이다.

#### SAP: 안정된 추상 원칙

> 컴포넌트는 안정된 정도만큼만 추상화되어야 한다.

##### 고수준 정책을 어디에 위치시켜야 하는가?

- 시스템에는 자주 변경해서는 절대로 안되는 소프트웨어도 있다. 고수준 아키텍처나 정책 결정과 관련된 소프트웨어가 그 예다.
  - 따라서 시스템에서 고수준 정책을 캡슐화하는 소프트웨어는 반드시 안정된 컴포넌트(I = 0)에 위치해야 한다.
- 하지만 고수준 정책을 안정된 컴포넌트에 위치시키면, 그 정책을 포함하는 소스 코드는 수정하기가 어려워진다. 이로 인해 시스템 전체 아키텍처가 유연성을 잃는다.
- 안정된 상태이면서 동시에 변경에 충분히 대응할 수 있도록 하려면 개방 폐쇄 원칙(OCP)를 원칙을 준수해야 한다.

##### 안정된 추상화 원칙

- 안정된 컴포넌트는 추상 컴포넌트여야 하며, 안정성이 컴포넌트를 확장하는 일을 방해해서는 안 된다고 말한다.
  - 불안정한 컴포넌트는 반드시 구체 컴포넌트여야 하며, 불안정하므로 컴포넌트 내부의 구체적인 코드를 쉽게 변경할 수 있어야 하기 때문이다.
- SAP와 SDP를 결합하면 컴포넌트에 대한 DIP나 마찬가지가 된다.
  - 실제로 SDP에서는 의존성이 반드시 안정성의 방향으로 향해야 한다고 말하고, SDP에서는 안정성이 결국 추상화를 의미한다고 말하기 때문이다.
  - 따라서 의존성은 추상화의 방향으로 향하게 된다.
- 핵심은, 안정적인 컴포넌트라면 반드시 인터페이스와 추상 클래스로 구성되어 쉽게 확장할 수 있어야 한다.

추상화 정도 관련 참고: https://velog.io/@ssuh0o0/Clean-Architecture-14%EC%9E%A5-%EC%BB%B4%ED%8F%AC%EB%84%8C%ED%8A%B8-%EA%B2%B0%ED%95%A9
